<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2d3436">
    <title>Maison Amarante</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 { font-size: 20px; font-weight: 600; }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 60px;
            z-index: 99;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #636e72;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active { color: #2d3436; border-bottom-color: #2d3436; }
        
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .card h3 { font-size: 16px; margin-bottom: 10px; color: #2d3436; }
        .card p { color: #636e72; font-size: 14px; line-height: 1.5; }
        
        .btn {
            width: 100%;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #00b894 0%, #55efc4 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%); color: #2d3436; }
        .btn-dark { background: #2d3436; color: white; }
        .btn:disabled { background: #b2bec3; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number { font-size: 24px; font-weight: 700; color: #6c5ce7; }
        .stat-label { font-size: 11px; color: #636e72; margin-top: 5px; }
        
        .loading { display: none; text-align: center; padding: 30px; }
        .loading.show { display: block; }
        
        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #f0f0f0;
            border-top-color: #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .details h4 { font-size: 13px; margin-bottom: 10px; color: #2d3436; }
        .detail-item { font-size: 12px; padding: 5px 0; border-bottom: 1px solid #e9ecef; color: #636e72; }
        .detail-item:last-child { border-bottom: none; }
        
        .error {
            background: #ffe6e6;
            border: 1px solid #e17055;
            color: #d63031;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            display: none;
        }
        
        .error.show { display: block; }
        
        /* Camera */
        .camera-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .preview {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            background: #e0e0e0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview img { width: 100%; height: 100%; object-fit: cover; }
        .preview-placeholder { color: #999; font-size: 13px; }
        
        input[type="file"] { display: none; }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .result-label { color: #636e72; }
        .result-value { color: #2d3436; font-weight: 500; }
        
        .success-badge {
            background: #00b894;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .success-badge a { color: white; }
        
        /* Tourn√©es */
        .tournee-group {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6c5ce7;
        }
        
        .tournee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .tournee-title { font-weight: 600; font-size: 14px; }
        .tournee-date { color: #6c5ce7; font-size: 13px; }
        .tournee-stats { font-size: 12px; color: #636e72; }
        
        .tournee-clients {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .client-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .client-name { color: #2d3436; }
        .client-info { color: #636e72; }
        
        /* Links */
        .links a {
            display: block;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #2d3436;
            text-decoration: none;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .links a:hover { background: #e9ecef; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå∏ Maison Amarante</h1>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="bouquet">üì∑ Bouquet</button>
        <button class="tab" data-tab="sync">üîÑ Sync</button>
        <button class="tab" data-tab="tournees">üöö Tourn√©es</button>
        <button class="tab" data-tab="dispatch">üíê Dispatch</button>
        <button class="tab" data-tab="liens">üîó Liens</button>
    </div>
    
    <!-- Bouquet Tab -->
    <div id="bouquet" class="tab-content active">
        <div class="camera-container">
            <div class="preview" id="preview">
                <span class="preview-placeholder">Aucune photo</span>
            </div>
            
            <input type="file" id="fileInput" accept="image/*">
            <button class="btn btn-dark" id="takePhotoBtn">üì∑ Prendre une photo</button>
            <button class="btn btn-primary" id="analyzeBtn" disabled>‚ú® Analyser et cr√©er</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Analyse en cours...</div>
            </div>
            
            <div class="result-card" id="resultCard" style="display: none;">
                <h3>‚úÖ Bouquet cr√©√©</h3>
                <div id="resultContent"></div>
                <div class="success-badge" id="successBadge"></div>
            </div>
        </div>
    </div>
    
    <!-- Sync Tab -->
    <div id="sync" class="tab-content">
        <div class="card">
            <h3>Synchronisation</h3>
            <p style="margin-bottom: 15px;">√âtape 1 : R√©cup√®re les donn√©es Pennylane ‚Üí Suivi Facturation</p>
            <button class="btn btn-primary" id="syncPennylaneBtn">1. Sync Pennylane</button>

            <p style="margin: 20px 0 15px 0; padding-top: 15px; border-top: 1px solid #eee;">√âtape 2 : Ajoute tes notes sur les cartes Suivi Facturation dans Airtable</p>

            <p style="margin-bottom: 15px;">√âtape 3 : Synchronise vers la base Clients (avec parsing IA des notes)</p>
            <button class="btn" style="background: #27ae60;" id="syncClientsBtn">2. Sync Clients</button>
            <button class="btn" style="background: #9b59b6; margin-left: 10px;" id="parseBtn">ü§ñ Re-parser les notes (IA)</button>

            <div class="loading" id="syncLoading">
                <div class="spinner"></div>
                <div id="loadingText">Synchronisation en cours...</div>
            </div>
            
            <div id="syncResults" style="display: none;">
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat1">0</div>
                        <div class="stat-label" id="syncLabel1">Clients cr√©√©s</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat2">0</div>
                        <div class="stat-label" id="syncLabel2">Mis √† jour</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat3">0</div>
                        <div class="stat-label" id="syncLabel3">Livraisons</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat4">0</div>
                        <div class="stat-label" id="syncLabel4">D√©sactiv√©s</div>
                    </div>
                </div>
                <div class="details" id="syncDetails">
                    <h4>D√©tails</h4>
                    <div id="syncDetailsList"></div>
                </div>
            </div>
            
            <div class="error" id="syncError"></div>
        </div>
        
        <div class="card" style="border: 2px solid #e74c3c;">
            <h3>üóëÔ∏è Reset complet</h3>
            <p>Supprime TOUTES les cartes Suivi Facturation + TOUS les clients (Airtable uniquement, ne touche pas Pennylane)</p>
            <button class="btn" style="background: #e74c3c;" id="cleanupBtn">Vider Suivi + Clients</button>
            <div id="cleanupResult" style="margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <!-- Tourn√©es Tab -->
    <div id="tournees" class="tab-content">
        <div class="card">
            <h3>üöö Tourn√©es de la semaine</h3>
            <p>G√©n√®re des itin√©raires optimis√©s, divis√©s par zones g√©ographiques (~12 clients max par tourn√©e)</p>
            <button class="btn btn-primary" id="prepareTourneesBtn">Calculer les tourn√©es</button>

            <div class="loading" id="tourneesLoading">
                <div class="spinner"></div>
                <div>Calcul des itin√©raires...</div>
            </div>

            <div id="tourneesResults" style="display: none;">
                <div class="stats" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-box">
                        <div class="stat-number" id="nbTournees">0</div>
                        <div class="stat-label">Tourn√©es</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clients</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalBouquets">0</div>
                        <div class="stat-label">Bouquets</div>
                    </div>
                </div>
                <p id="tourneesMessage" style="text-align: center; margin: 10px 0; color: #666; font-size: 0.9em;"></p>
            </div>

            <div class="error" id="tourneesError"></div>
        </div>

        <div id="tourneesList" style="display: none;"></div>
    </div>

    <!-- Dispatch Tab -->
    <div id="dispatch" class="tab-content">
        <div class="card">
            <h3>üíê Dispatch des bouquets</h3>
            <p>S√©lectionne une tourn√©e pour pr√©parer les bouquets</p>
            <button class="btn btn-primary" id="loadTourneesBtn">Charger les tourn√©es</button>

            <div class="loading" id="dispatchLoading">
                <div class="spinner"></div>
                <div id="dispatchLoadingText">Chargement...</div>
            </div>

            <div class="error" id="dispatchError"></div>
        </div>

        <!-- Liste des tourn√©es -->
        <div id="tourneeSelector" style="display: none;"></div>

        <!-- Dispatch pour la tourn√©e s√©lectionn√©e -->
        <div id="dispatchContent" style="display: none;">
            <div class="card" style="background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 id="selectedTourneeTitle" style="margin: 0;"></h4>
                        <p id="selectedTourneeInfo" style="margin: 5px 0 0; font-size: 0.9em; color: #666;"></p>
                    </div>
                    <button class="btn" id="backToTourneesBtn" style="background: #636e72; padding: 8px 15px;">Retour</button>
                </div>
            </div>
            <div id="dispatchList"></div>
        </div>

        <!-- Donn√©es de test -->
        <div class="card" style="border: 2px dashed #6c5ce7; margin-top: 15px;">
            <h3>üß™ Donn√©es de test</h3>
            <p>G√©n√©rer des bouquets fake pour tester le dispatch</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="fakeBouquetsBtn" style="flex: 1; min-width: 150px;">Cr√©er 60 bouquets</button>
                <button class="btn" id="cleanupBouquetsBtn" style="flex: 1; min-width: 150px; background: #e74c3c;">Supprimer FAKE</button>
            </div>
            <div id="fakeBouquetsResult" style="margin-top: 10px; display: none; font-size: 0.9em;"></div>
        </div>
    </div>

    <!-- Liens Tab -->
    <div id="liens" class="tab-content">
        <div class="card">
            <h3>üìä Bases de donn√©es</h3>
            <div class="links">
                <a href="https://airtable.com/app4EHdsU0Z4hr8Bc" target="_blank">üì¶ Maison Amarante DB</a>
                <a href="https://airtable.com/appxlOtjRVYqbW85l" target="_blank">üí∞ Suivi Facturation</a>
                <a href="https://app.pennylane.com" target="_blank">üìë Pennylane</a>
            </div>
        </div>
        
        <div class="card">
            <h3>‚öôÔ∏è API</h3>
            <div class="links">
                <a href="/api/health" target="_blank">üîç Status API</a>
            </div>
        </div>
    </div>
    
    <script>
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Camera
        const fileInput = document.getElementById('fileInput');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const preview = document.getElementById('preview');
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');
        
        let currentImageBase64 = null;
        
        takePhotoBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await compressImage(file);
            currentImageBase64 = base64;
            
            preview.innerHTML = `<img src="data:image/jpeg;base64,${base64}" alt="Preview">`;
            analyzeBtn.disabled = false;
            resultCard.style.display = 'none';
        });
        
        async function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const maxSize = 1200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height && width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        analyzeBtn.addEventListener('click', async () => {
            if (!currentImageBase64) return;
            
            analyzeBtn.disabled = true;
            loading.classList.add('show');
            resultCard.style.display = 'none';
            
            try {
                const response = await fetch('/analyze-and-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_base64: currentImageBase64, media_type: 'image/jpeg' })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Erreur: ' + data.error);
                    return;
                }
                
                const analysis = data.analysis;
                const created = data.created;

                let html = '';
                if (analysis.style) html += `<div class="result-row"><span class="result-label">Style</span><span class="result-value">${analysis.style}</span></div>`;
                if (analysis.taille_suggeree) html += `<div class="result-row"><span class="result-label">Taille</span><span class="result-value">${analysis.taille_suggeree}</span></div>`;
                if (analysis.couleurs?.length) html += `<div class="result-row"><span class="result-label">Couleurs</span><span class="result-value">${analysis.couleurs.join(', ')}</span></div>`;

                document.getElementById('resultContent').innerHTML = html;

                // V√©rifier si la cr√©ation a r√©ussi
                if (!created || !created.success) {
                    document.getElementById('successBadge').innerHTML = `<span style="color: #e74c3c;">‚ùå Erreur: ${created?.error || 'Cr√©ation √©chou√©e'}</span>`;
                    document.getElementById('successBadge').style.background = '#ffe6e6';
                } else {
                    document.getElementById('successBadge').innerHTML = `<strong>${created.bouquet_id}</strong><br><a href="${created.public_url}" target="_blank">Voir la fiche ‚Üí</a>`;
                    document.getElementById('successBadge').style.background = '#00b894';
                    currentImageBase64 = null;
                    preview.innerHTML = '<span class="preview-placeholder">Aucune photo</span>';
                }

                resultCard.style.display = 'block';
                
            } catch (err) {
                alert('Erreur: ' + err.message);
            } finally {
                loading.classList.remove('show');
                analyzeBtn.disabled = true;
            }
        });
        
        // Sync
        const syncPennylaneBtn = document.getElementById('syncPennylaneBtn');
        const syncClientsBtn = document.getElementById('syncClientsBtn');
        const syncLoading = document.getElementById('syncLoading');
        const syncResults = document.getElementById('syncResults');
        const syncError = document.getElementById('syncError');

        async function doSync(endpoint, btn, syncType) {
            btn.disabled = true;
            syncLoading.classList.add('show');
            document.getElementById('loadingText').textContent = syncType === 'pennylane'
                ? 'Sync Pennylane en cours...'
                : 'Sync Clients en cours...';
            syncResults.style.display = 'none';
            syncError.classList.remove('show');

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    syncError.textContent = 'Erreur: ' + data.error;
                    syncError.classList.add('show');
                    return;
                }

                if (syncType === 'pennylane') {
                    // Sync Pennylane uniquement
                    const totalCartes = (data.quotes_synced || 0) + (data.invoices_synced || 0) + (data.subscriptions_synced || 0);
                    document.getElementById('syncStat1').textContent = data.quotes_synced || 0;
                    document.getElementById('syncLabel1').textContent = 'Devis';
                    document.getElementById('syncStat2').textContent = data.invoices_synced || 0;
                    document.getElementById('syncLabel2').textContent = 'Factures';
                    document.getElementById('syncStat3').textContent = data.subscriptions_synced || 0;
                    document.getElementById('syncLabel3').textContent = 'Abonnements';
                    document.getElementById('syncStat4').textContent = totalCartes;
                    document.getElementById('syncLabel4').textContent = 'Total cartes';
                } else {
                    // Sync Clients
                    document.getElementById('syncStat1').textContent = data.clients_created || 0;
                    document.getElementById('syncLabel1').textContent = 'Clients cr√©√©s';
                    document.getElementById('syncStat2').textContent = data.clients_updated || 0;
                    document.getElementById('syncLabel2').textContent = 'Mis √† jour';
                    document.getElementById('syncStat3').textContent = data.notes_parsed || 0;
                    document.getElementById('syncLabel3').textContent = 'Notes pars√©es';
                    document.getElementById('syncStat4').textContent = data.livraisons_created || 0;
                    document.getElementById('syncLabel4').textContent = 'Livraisons';
                }

                const details = data.details || [];
                document.getElementById('syncDetailsList').innerHTML = details.length
                    ? details.map(d => `<div class="detail-item">${d}</div>`).join('')
                    : '<div class="detail-item">Aucune modification</div>';

                syncResults.style.display = 'block';

            } catch (err) {
                syncError.textContent = 'Erreur: ' + err.message;
                syncError.classList.add('show');
            } finally {
                syncLoading.classList.remove('show');
                btn.disabled = false;
            }
        }

        // Boutons s√©par√©s
        syncPennylaneBtn.addEventListener('click', () => doSync('/api/sync/pennylane', syncPennylaneBtn, 'pennylane'));
        syncClientsBtn.addEventListener('click', () => doSync('/api/sync/clients', syncClientsBtn, 'clients'));

        // Parse notes avec IA
        const parseBtn = document.getElementById('parseBtn');
        parseBtn.addEventListener('click', async () => {
            parseBtn.disabled = true;
            syncPennylaneBtn.disabled = true;
            syncClientsBtn.disabled = true;
            syncLoading.classList.add('show');
            document.getElementById('loadingText').textContent = 'Parsing IA en cours (peut prendre 1-2 min)...';
            syncResults.style.display = 'none';
            syncError.classList.remove('show');

            let totalParsed = 0;
            let totalUpdated = 0;
            let offset = 0;
            const limit = 15;

            try {
                // Parse par batches de 15
                while (true) {
                    const response = await fetch(`/api/parse-clients?limit=${limit}&offset=${offset}`, { method: 'POST' });
                    const data = await response.json();

                    if (data.error) {
                        syncError.textContent = 'Erreur: ' + data.error;
                        syncError.classList.add('show');
                        break;
                    }

                    totalParsed += data.parsed || 0;
                    totalUpdated += data.updated || 0;
                    document.getElementById('loadingText').textContent = `Parsing IA... ${totalParsed} notes trait√©es`;

                    if (!data.next_offset) break;
                    offset = data.next_offset;
                }

                // Afficher r√©sultats
                document.getElementById('syncStat1').textContent = totalParsed;
                document.getElementById('syncLabel1').textContent = 'Notes pars√©es';
                document.getElementById('syncStat2').textContent = totalUpdated;
                document.getElementById('syncLabel2').textContent = 'Clients mis √† jour';
                document.getElementById('syncStat3').textContent = '-';
                document.getElementById('syncLabel3').textContent = '';
                document.getElementById('syncStat4').textContent = '-';
                document.getElementById('syncLabel4').textContent = '';
                document.getElementById('syncDetailsList').innerHTML = '<p>Champs remplis: Adresse, Cr√©neau, Notes_Sp√©ciales, Nb_Bouquets, Couleurs, Style</p>';
                syncResults.style.display = 'block';
            } catch (err) {
                syncError.textContent = 'Erreur: ' + err.message;
                syncError.classList.add('show');
            } finally {
                syncLoading.classList.remove('show');
                parseBtn.disabled = false;
                syncPennylaneBtn.disabled = false;
                syncClientsBtn.disabled = false;
            }
        });

        // Cleanup
        const cleanupBtn = document.getElementById('cleanupBtn');
        const cleanupResult = document.getElementById('cleanupResult');
        cleanupBtn.addEventListener('click', async () => {
            if (!confirm('ATTENTION: Supprimer TOUTES les cartes Suivi Facturation + TOUS les clients ?\n\n(Pennylane ne sera pas touch√©)')) return;
            cleanupBtn.disabled = true;
            cleanupResult.innerHTML = '<span style="color: #888;">Suppression en cours...</span>';
            cleanupResult.style.display = 'block';
            try {
                const response = await fetch('/api/test/cleanup', { method: 'POST' });
                const data = await response.json();
                cleanupResult.innerHTML = `<span style="color: #27ae60;">‚úÖ ${data.suivi_deleted || 0} cartes Suivi + ${data.clients_deleted || 0} clients supprim√©s</span>`;
            } catch (err) {
                cleanupResult.innerHTML = `<span style="color: #e74c3c;">‚ùå Erreur: ${err.message}</span>`;
            } finally {
                cleanupBtn.disabled = false;
            }
        });

        // Tourn√©es
        const prepareTourneesBtn = document.getElementById('prepareTourneesBtn');
        const tourneesLoading = document.getElementById('tourneesLoading');
        const tourneesResults = document.getElementById('tourneesResults');
        const tourneesList = document.getElementById('tourneesList');
        const tourneesError = document.getElementById('tourneesError');

        // Couleurs pour les tourn√©es
        const tourneeColors = ['#6c5ce7', '#00b894', '#e17055', '#0984e3', '#fdcb6e', '#e84393'];

        prepareTourneesBtn.addEventListener('click', async () => {
            prepareTourneesBtn.disabled = true;
            tourneesLoading.classList.add('show');
            tourneesResults.style.display = 'none';
            tourneesList.style.display = 'none';
            tourneesError.classList.remove('show');

            try {
                const response = await fetch('/api/tournees');
                const data = await response.json();

                if (data.error) {
                    tourneesError.textContent = 'Erreur: ' + data.error;
                    tourneesError.classList.add('show');
                    return;
                }

                // Stats globales
                document.getElementById('nbTournees').textContent = data.nb_tournees || 0;
                document.getElementById('totalClients').textContent = data.total_clients || 0;
                document.getElementById('totalBouquets').textContent = data.total_bouquets || 0;
                document.getElementById('tourneesMessage').textContent = data.message || '';

                tourneesResults.style.display = 'block';

                // Afficher chaque tourn√©e
                const tournees = data.tournees || [];
                if (tournees.length === 0) {
                    tourneesList.innerHTML = '<div class="card"><p>Aucun client √† livrer.</p></div>';
                    tourneesList.style.display = 'block';
                } else {
                    tourneesList.innerHTML = tournees.map((t, idx) => {
                        const color = tourneeColors[idx % tourneeColors.length];
                        const clients = t.clients || [];
                        return `
                            <div class="card" style="border-left: 4px solid ${color}; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="margin: 0; color: ${color};">Tourn√©e ${t.numero}</h4>
                                        <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                                            üìÖ ${t.jour} ¬∑ ${t.nb_clients} clients ¬∑ ${t.nb_bouquets} bouquets ¬∑ ~${t.duree_estimee}
                                        </div>
                                        <div style="font-size: 0.8em; color: #999; margin-top: 2px;">
                                            ${t.zones?.join(', ') || ''}
                                        </div>
                                    </div>
                                </div>
                                <a href="${t.google_maps_url}" target="_blank" class="btn" style="background: ${color}; display: block; text-align: center; margin: 10px 0; padding: 10px;">
                                    üó∫Ô∏è Ouvrir dans Google Maps
                                </a>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #666; font-size: 0.9em;">Voir les ${clients.length} clients</summary>
                                    <div style="margin-top: 10px;">
                                        ${clients.map((c, i) => `
                                            <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                                <span style="background: ${color}; color: white; border-radius: 50%; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 0.75em;">${i + 1}</span>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 600; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.nom}</div>
                                                    <div style="font-size: 0.8em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.adresse || 'Pas d\'adresse'}</div>
                                                    <div style="font-size: 0.75em; color: #999;">${c.nb_bouquets} bouquet(s) ${c.creneau ? '¬∑ ' + c.creneau : ''}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            </div>
                        `;
                    }).join('');
                    tourneesList.style.display = 'block';
                }

            } catch (err) {
                tourneesError.textContent = 'Erreur: ' + err.message;
                tourneesError.classList.add('show');
            } finally {
                tourneesLoading.classList.remove('show');
                prepareTourneesBtn.disabled = false;
            }
        });

        // Dispatch - S√©lection par tourn√©e
        const loadTourneesBtn = document.getElementById('loadTourneesBtn');
        const dispatchLoading = document.getElementById('dispatchLoading');
        const dispatchLoadingText = document.getElementById('dispatchLoadingText');
        const dispatchError = document.getElementById('dispatchError');
        const tourneeSelector = document.getElementById('tourneeSelector');
        const dispatchContent = document.getElementById('dispatchContent');
        const dispatchList = document.getElementById('dispatchList');
        const backToTourneesBtn = document.getElementById('backToTourneesBtn');

        // Couleurs pour les scores
        function getScoreColor(score) {
            if (score >= 80) return '#00b894';
            if (score >= 60) return '#fdcb6e';
            if (score >= 40) return '#e17055';
            return '#d63031';
        }

        // Couleurs pour les tourn√©es
        const dispatchColors = ['#6c5ce7', '#00b894', '#e17055', '#0984e3', '#fdcb6e', '#e84393'];

        // Charger la liste des tourn√©es
        loadTourneesBtn.addEventListener('click', async () => {
            loadTourneesBtn.disabled = true;
            dispatchLoading.classList.add('show');
            dispatchLoadingText.textContent = 'Chargement des tourn√©es...';
            tourneeSelector.style.display = 'none';
            dispatchContent.style.display = 'none';
            dispatchError.classList.remove('show');

            try {
                const response = await fetch('/api/dispatch/tournees');
                const data = await response.json();

                if (data.error) {
                    dispatchError.textContent = 'Erreur: ' + data.error;
                    dispatchError.classList.add('show');
                    return;
                }

                const tournees = data.tournees || [];
                if (tournees.length === 0) {
                    tourneeSelector.innerHTML = '<div class="card"><p>Aucune tourn√©e disponible. Synchronisez d\'abord les clients.</p></div>';
                } else {
                    tourneeSelector.innerHTML = tournees.map((t, idx) => {
                        const color = dispatchColors[idx % dispatchColors.length];
                        return `
                            <div class="card" style="border-left: 4px solid ${color}; margin-bottom: 10px; cursor: pointer;"
                                 onclick="loadDispatchForTournee(${t.numero})"
                                 onmouseover="this.style.background='#f8f9fa'"
                                 onmouseout="this.style.background='white'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0; color: ${color};">Tourn√©e ${t.numero}</h4>
                                        <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                                            üìÖ ${t.jour} ¬∑ ${t.nb_clients} clients ¬∑ ${t.nb_bouquets} bouquets
                                        </div>
                                        <div style="font-size: 0.8em; color: #999; margin-top: 2px;">
                                            ${t.zones?.join(', ') || ''}
                                        </div>
                                    </div>
                                    <div style="font-size: 1.5em; color: #ccc;">‚Ä∫</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                tourneeSelector.style.display = 'block';

            } catch (err) {
                dispatchError.textContent = 'Erreur: ' + err.message;
                dispatchError.classList.add('show');
            } finally {
                dispatchLoading.classList.remove('show');
                loadTourneesBtn.disabled = false;
            }
        });

        // Charger le dispatch pour une tourn√©e
        window.loadDispatchForTournee = async function(tourneeNum) {
            dispatchLoading.classList.add('show');
            dispatchLoadingText.textContent = `Calcul des suggestions pour la tourn√©e ${tourneeNum}...`;
            tourneeSelector.style.display = 'none';
            dispatchError.classList.remove('show');

            try {
                const response = await fetch(`/api/dispatch/${tourneeNum}`);
                const data = await response.json();

                if (data.error || !data.success) {
                    dispatchError.textContent = data.message || data.error || 'Erreur';
                    dispatchError.classList.add('show');
                    tourneeSelector.style.display = 'block';
                    return;
                }

                const tournee = data.tournee || {};
                const color = dispatchColors[(tourneeNum - 1) % dispatchColors.length];

                document.getElementById('selectedTourneeTitle').innerHTML = `<span style="color: ${color};">Tourn√©e ${tournee.numero}</span> - ${tournee.jour}`;
                document.getElementById('selectedTourneeInfo').textContent = `${tournee.nb_clients} clients ¬∑ ${tournee.nb_bouquets} bouquets ¬∑ ${tournee.zones?.join(', ') || ''}`;

                // Afficher les clients avec suggestions
                const dispatch = data.dispatch || [];
                if (dispatch.length === 0) {
                    dispatchList.innerHTML = '<div class="card"><p>Aucun client dans cette tourn√©e.</p></div>';
                } else {
                    dispatchList.innerHTML = dispatch.map((d, clientIdx) => {
                        const prefs = d.preferences || {};
                        const bouquets = d.bouquets_suggeres || [];
                        const alternatives = d.alternatives || [];
                        const isComplete = d.complet;

                        return `
                            <div class="card" style="margin-bottom: 15px;" id="client-${clientIdx}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="margin: 0;">${d.client_nom}</h4>
                                        <div style="font-size: 0.8em; color: #666;">${d.client_adresse || ''}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: ${isComplete ? '#00b894' : '#e17055'}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">
                                            ${d.nb_suggeres}/${d.nb_demandes}
                                        </span>
                                    </div>
                                </div>

                                ${prefs.couleurs || prefs.style || prefs.tailles ? `
                                    <div style="padding: 8px; background: #f0f0f0; border-radius: 6px; font-size: 0.8em; margin-bottom: 10px;">
                                        ${prefs.couleurs ? `<span>üé® ${prefs.couleurs}</span>` : ''}
                                        ${prefs.style ? `<span style="margin-left: 10px;">‚ú® ${prefs.style}</span>` : ''}
                                        ${prefs.tailles ? `<span style="margin-left: 10px;">üìè ${prefs.tailles}</span>` : ''}
                                    </div>
                                ` : ''}

                                ${bouquets.length > 0 ? bouquets.map((b, bIdx) => `
                                    <div style="display: flex; align-items: center; padding: 10px; margin: 8px 0; background: #fafafa; border-radius: 8px; border: 2px solid #e0e0e0;" id="suggestion-${clientIdx}-${bIdx}">
                                        ${b.bouquet_photo ? `<img src="${b.bouquet_photo}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 12px;">` : '<div style="width: 60px; height: 60px; background: #ddd; border-radius: 8px; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">üå∏</div>'}
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600;">${b.bouquet_nom || b.bouquet_id}</div>
                                            <div style="font-size: 0.85em; color: #666;">
                                                ${b.bouquet_style || ''} ¬∑ ${b.bouquet_taille || ''}
                                            </div>
                                            <div style="font-size: 0.8em; color: #999;">
                                                ${Array.isArray(b.bouquet_couleurs) ? b.bouquet_couleurs.join(', ') : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                                            <div style="background: ${getScoreColor(b.score)}; color: white; padding: 4px 10px; border-radius: 10px; font-weight: bold; font-size: 0.85em; text-align: center;">
                                                ${b.score}%
                                            </div>
                                            <button onclick="validerBouquet('${d.client_id}', '${b.record_id}', ${clientIdx}, ${bIdx})"
                                                    style="background: #00b894; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em;">
                                                ‚úì Valider
                                            </button>
                                        </div>
                                    </div>
                                `).join('') : '<p style="color: #999; font-size: 0.9em;">Aucun bouquet correspondant</p>'}

                                ${alternatives.length > 0 ? `
                                    <details style="margin-top: 8px;">
                                        <summary style="cursor: pointer; color: #666; font-size: 0.85em;">Voir ${alternatives.length} alternative(s)</summary>
                                        <div style="margin-top: 8px;">
                                            ${alternatives.map((a, aIdx) => `
                                                <div style="display: flex; align-items: center; padding: 8px; margin: 5px 0; background: #f5f5f5; border-radius: 6px; border: 1px dashed #ccc;">
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 0.85em;">${a.bouquet_nom || a.bouquet_id}</div>
                                                        <div style="font-size: 0.75em; color: #999;">${a.bouquet_style} ¬∑ ${a.bouquet_taille}</div>
                                                    </div>
                                                    <span style="background: ${getScoreColor(a.score)}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.75em;">${a.score}%</span>
                                                    <button onclick="validerBouquet('${d.client_id}', '${a.record_id}', ${clientIdx}, 'alt-${aIdx}')"
                                                            style="background: #636e72; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-left: 8px;">
                                                        Choisir
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }

                dispatchContent.style.display = 'block';

            } catch (err) {
                dispatchError.textContent = 'Erreur: ' + err.message;
                dispatchError.classList.add('show');
                tourneeSelector.style.display = 'block';
            } finally {
                dispatchLoading.classList.remove('show');
            }
        };

        // Valider un bouquet
        window.validerBouquet = async function(clientId, bouquetRecordId, clientIdx, bouquetIdx) {
            const suggestionEl = document.getElementById(`suggestion-${clientIdx}-${bouquetIdx}`);
            if (suggestionEl) {
                suggestionEl.style.opacity = '0.5';
            }

            try {
                const response = await fetch('/api/dispatch/valider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: clientId, bouquet_record_id: bouquetRecordId })
                });
                const data = await response.json();

                if (data.success) {
                    if (suggestionEl) {
                        suggestionEl.style.border = '2px solid #00b894';
                        suggestionEl.style.background = '#e8f8f5';
                        suggestionEl.style.opacity = '1';
                        suggestionEl.querySelector('button').textContent = '‚úì Valid√©';
                        suggestionEl.querySelector('button').disabled = true;
                        suggestionEl.querySelector('button').style.background = '#b2bec3';
                    }
                } else {
                    alert('Erreur: ' + (data.error || 'Validation impossible'));
                    if (suggestionEl) suggestionEl.style.opacity = '1';
                }
            } catch (err) {
                alert('Erreur: ' + err.message);
                if (suggestionEl) suggestionEl.style.opacity = '1';
            }
        };

        // Retour √† la liste des tourn√©es
        backToTourneesBtn.addEventListener('click', () => {
            dispatchContent.style.display = 'none';
            tourneeSelector.style.display = 'block';
        });

        // Fake bouquets
        const fakeBouquetsBtn = document.getElementById('fakeBouquetsBtn');
        const cleanupBouquetsBtn = document.getElementById('cleanupBouquetsBtn');
        const fakeBouquetsResult = document.getElementById('fakeBouquetsResult');

        fakeBouquetsBtn.addEventListener('click', async () => {
            fakeBouquetsBtn.disabled = true;
            cleanupBouquetsBtn.disabled = true;
            fakeBouquetsResult.innerHTML = '<span style="color: #666;">Cr√©ation en cours...</span>';
            fakeBouquetsResult.style.display = 'block';

            try {
                const response = await fetch('/api/test/fake-bouquets', { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    fakeBouquetsResult.innerHTML = `<span style="color: #e74c3c;">‚ùå ${data.error}</span>`;
                } else {
                    fakeBouquetsResult.innerHTML = `<span style="color: #00b894;">‚úÖ ${data.message}</span>`;
                }
            } catch (err) {
                fakeBouquetsResult.innerHTML = `<span style="color: #e74c3c;">‚ùå ${err.message}</span>`;
            } finally {
                fakeBouquetsBtn.disabled = false;
                cleanupBouquetsBtn.disabled = false;
            }
        });

        cleanupBouquetsBtn.addEventListener('click', async () => {
            if (!confirm('Supprimer tous les bouquets FAKE ?')) return;

            fakeBouquetsBtn.disabled = true;
            cleanupBouquetsBtn.disabled = true;
            fakeBouquetsResult.innerHTML = '<span style="color: #666;">Suppression en cours...</span>';
            fakeBouquetsResult.style.display = 'block';

            try {
                const response = await fetch('/api/test/cleanup-bouquets', { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    fakeBouquetsResult.innerHTML = `<span style="color: #e74c3c;">‚ùå ${data.error}</span>`;
                } else {
                    fakeBouquetsResult.innerHTML = `<span style="color: #00b894;">‚úÖ ${data.message}</span>`;
                }
            } catch (err) {
                fakeBouquetsResult.innerHTML = `<span style="color: #e74c3c;">‚ùå ${err.message}</span>`;
            } finally {
                fakeBouquetsBtn.disabled = false;
                cleanupBouquetsBtn.disabled = false;
            }
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>
