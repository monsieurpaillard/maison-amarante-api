<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2d3436">
    <title>Maison Amarante</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 { font-size: 20px; font-weight: 600; }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 60px;
            z-index: 99;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #636e72;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active { color: #2d3436; border-bottom-color: #2d3436; }
        
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .card h3 { font-size: 16px; margin-bottom: 10px; color: #2d3436; }
        .card p { color: #636e72; font-size: 14px; line-height: 1.5; }
        
        .btn {
            width: 100%;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #00b894 0%, #55efc4 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%); color: #2d3436; }
        .btn-dark { background: #2d3436; color: white; }
        .btn:disabled { background: #b2bec3; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number { font-size: 24px; font-weight: 700; color: #6c5ce7; }
        .stat-label { font-size: 11px; color: #636e72; margin-top: 5px; }
        
        .loading { display: none; text-align: center; padding: 30px; }
        .loading.show { display: block; }
        
        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #f0f0f0;
            border-top-color: #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .details h4 { font-size: 13px; margin-bottom: 10px; color: #2d3436; }
        .detail-item { font-size: 12px; padding: 5px 0; border-bottom: 1px solid #e9ecef; color: #636e72; }
        .detail-item:last-child { border-bottom: none; }
        
        .error {
            background: #ffe6e6;
            border: 1px solid #e17055;
            color: #d63031;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            display: none;
        }
        
        .error.show { display: block; }
        
        /* Camera */
        .camera-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .preview {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            background: #e0e0e0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview img { width: 100%; height: 100%; object-fit: cover; }
        .preview-placeholder { color: #999; font-size: 13px; }
        
        input[type="file"] { display: none; }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .result-label { color: #636e72; }
        .result-value { color: #2d3436; font-weight: 500; }
        
        .success-badge {
            background: #00b894;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .success-badge a { color: white; }
        
        /* Tourn√©es */
        .tournee-group {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6c5ce7;
        }
        
        .tournee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .tournee-title { font-weight: 600; font-size: 14px; }
        .tournee-date { color: #6c5ce7; font-size: 13px; }
        .tournee-stats { font-size: 12px; color: #636e72; }
        
        .tournee-clients {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .client-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .client-name { color: #2d3436; }
        .client-info { color: #636e72; }
        
        /* Links */
        .links a {
            display: block;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #2d3436;
            text-decoration: none;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .links a:hover { background: #e9ecef; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå∏ Maison Amarante</h1>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="bouquet">üì∑ Bouquet</button>
        <button class="tab" data-tab="sync">üîÑ Sync</button>
        <button class="tab" data-tab="tournees">üöö Tourn√©es</button>
        <button class="tab" data-tab="liens">üîó Liens</button>
    </div>
    
    <!-- Bouquet Tab -->
    <div id="bouquet" class="tab-content active">
        <div class="camera-container">
            <div class="preview" id="preview">
                <span class="preview-placeholder">Aucune photo</span>
            </div>
            
            <input type="file" id="fileInput" accept="image/*" capture="environment">
            <button class="btn btn-dark" id="takePhotoBtn">üì∑ Prendre une photo</button>
            <button class="btn btn-primary" id="analyzeBtn" disabled>‚ú® Analyser et cr√©er</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Analyse en cours...</div>
            </div>
            
            <div class="result-card" id="resultCard" style="display: none;">
                <h3>‚úÖ Bouquet cr√©√©</h3>
                <div id="resultContent"></div>
                <div class="success-badge" id="successBadge"></div>
            </div>
        </div>
    </div>
    
    <!-- Sync Tab -->
    <div id="sync" class="tab-content">
        <div class="card">
            <h3>üîÑ Synchronisation compl√®te</h3>
            <p>Synchronise Pennylane ‚Üí Suivi Facturation ‚Üí Base Clients</p>
            <button class="btn btn-primary" id="syncAllBtn">Tout synchroniser</button>
            
            <div class="loading" id="syncLoading">
                <div class="spinner"></div>
                <div>Synchronisation en cours...</div>
            </div>
            
            <div id="syncResults" style="display: none;">
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat1">0</div>
                        <div class="stat-label" id="syncLabel1">Clients cr√©√©s</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat2">0</div>
                        <div class="stat-label" id="syncLabel2">Mis √† jour</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat3">0</div>
                        <div class="stat-label" id="syncLabel3">Livraisons</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="syncStat4">0</div>
                        <div class="stat-label" id="syncLabel4">D√©sactiv√©s</div>
                    </div>
                </div>
                <div class="details" id="syncDetails">
                    <h4>D√©tails</h4>
                    <div id="syncDetailsList"></div>
                </div>
            </div>
            
            <div class="error" id="syncError"></div>
        </div>
        
        <div class="card">
            <h3>üß™ Sync Pennylane (SANDBOX)</h3>
            <p>‚ö†Ô∏è Mode test : utilise des donn√©es fake, pas le vrai Pennylane</p>
            <button class="btn btn-warning" id="syncPennylaneBtn">Sync Fake Pennylane</button>
        </div>
        
        <div class="card">
            <h3>üë• Sync Clients uniquement</h3>
            <p>Met √† jour les clients depuis Suivi Facturation</p>
            <button class="btn btn-success" id="syncClientsBtn">Sync Clients</button>
        </div>

        <div class="card" style="border: 2px solid #e74c3c;">
            <h3>üóëÔ∏è Cleanup Test Data</h3>
            <p>Supprime toutes les donn√©es TEST et FAKE des bases Airtable</p>
            <button class="btn" style="background: #e74c3c;" id="cleanupBtn">Nettoyer les donn√©es test</button>
            <div id="cleanupResult" style="margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <!-- Tourn√©es Tab -->
    <div id="tournees" class="tab-content">
        <div class="card">
            <h3>üöö Pr√©parer les tourn√©es</h3>
            <p>G√©n√®re les suggestions de tourn√©es optimis√©es par zone et persona</p>
            <button class="btn btn-primary" id="prepareTourneesBtn">Pr√©parer les tourn√©es</button>
            
            <div class="loading" id="tourneesLoading">
                <div class="spinner"></div>
                <div>Calcul en cours...</div>
            </div>
            
            <div id="tourneesResults" style="display: none;">
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clients √† livrer</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalBouquets">0</div>
                        <div class="stat-label">Bouquets</div>
                    </div>
                </div>
            </div>
            
            <div class="error" id="tourneesError"></div>
        </div>
        
        <div id="tourneesList"></div>
    </div>
    
    <!-- Liens Tab -->
    <div id="liens" class="tab-content">
        <div class="card">
            <h3>üìä Bases de donn√©es</h3>
            <div class="links">
                <a href="https://airtable.com/app4EHdsU0Z4hr8Bc" target="_blank">üì¶ Maison Amarante DB</a>
                <a href="https://airtable.com/appxlOtjRVYqbW85l" target="_blank">üí∞ Suivi Facturation</a>
                <a href="https://app.pennylane.com" target="_blank">üìë Pennylane</a>
            </div>
        </div>
        
        <div class="card">
            <h3>‚öôÔ∏è API</h3>
            <div class="links">
                <a href="/api/health" target="_blank">üîç Status API</a>
            </div>
        </div>
    </div>
    
    <script>
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Camera
        const fileInput = document.getElementById('fileInput');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const preview = document.getElementById('preview');
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');
        
        let currentImageBase64 = null;
        
        takePhotoBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await compressImage(file);
            currentImageBase64 = base64;
            
            preview.innerHTML = `<img src="data:image/jpeg;base64,${base64}" alt="Preview">`;
            analyzeBtn.disabled = false;
            resultCard.style.display = 'none';
        });
        
        async function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const maxSize = 1200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height && width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        analyzeBtn.addEventListener('click', async () => {
            if (!currentImageBase64) return;
            
            analyzeBtn.disabled = true;
            loading.classList.add('show');
            resultCard.style.display = 'none';
            
            try {
                const response = await fetch('/analyze-and-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_base64: currentImageBase64, media_type: 'image/jpeg' })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Erreur: ' + data.error);
                    return;
                }
                
                const analysis = data.analysis;
                const created = data.created;
                
                let html = '';
                if (analysis.style) html += `<div class="result-row"><span class="result-label">Style</span><span class="result-value">${analysis.style}</span></div>`;
                if (analysis.taille_suggeree) html += `<div class="result-row"><span class="result-label">Taille</span><span class="result-value">${analysis.taille_suggeree}</span></div>`;
                if (analysis.couleurs?.length) html += `<div class="result-row"><span class="result-label">Couleurs</span><span class="result-value">${analysis.couleurs.join(', ')}</span></div>`;
                
                document.getElementById('resultContent').innerHTML = html;
                document.getElementById('successBadge').innerHTML = `<strong>${created.bouquet_id}</strong><br><a href="${created.public_url}" target="_blank">Voir la fiche ‚Üí</a>`;
                
                resultCard.style.display = 'block';
                currentImageBase64 = null;
                preview.innerHTML = '<span class="preview-placeholder">Aucune photo</span>';
                
            } catch (err) {
                alert('Erreur: ' + err.message);
            } finally {
                loading.classList.remove('show');
                analyzeBtn.disabled = true;
            }
        });
        
        // Sync
        const syncAllBtn = document.getElementById('syncAllBtn');
        const syncPennylaneBtn = document.getElementById('syncPennylaneBtn');
        const syncClientsBtn = document.getElementById('syncClientsBtn');
        const syncLoading = document.getElementById('syncLoading');
        const syncResults = document.getElementById('syncResults');
        const syncError = document.getElementById('syncError');
        
        async function doSync(endpoint, btn) {
            btn.disabled = true;
            syncLoading.classList.add('show');
            syncResults.style.display = 'none';
            syncError.classList.remove('show');
            
            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();
                
                if (data.error) {
                    syncError.textContent = 'Erreur: ' + data.error;
                    syncError.classList.add('show');
                    return;
                }
                
                // Extraire les stats selon le type de r√©ponse
                const isPennylaneSync = data.quotes_synced !== undefined;

                if (isPennylaneSync) {
                    // Stats Pennylane (cartes cr√©√©es dans Suivi Facturation)
                    document.getElementById('syncStat1').textContent = data.quotes_synced || 0;
                    document.getElementById('syncLabel1').textContent = 'Devis';
                    document.getElementById('syncStat2').textContent = data.invoices_synced || 0;
                    document.getElementById('syncLabel2').textContent = 'Factures';
                    document.getElementById('syncStat3').textContent = (data.essais_synced || 0) + (data.a_livrer_synced || 0);
                    document.getElementById('syncLabel3').textContent = 'Essais/√Ä livrer';
                    document.getElementById('syncStat4').textContent = data.subscriptions_synced || 0;
                    document.getElementById('syncLabel4').textContent = 'Abonnements';
                } else {
                    // Stats Clients (clients cr√©√©s/mis √† jour)
                    const clients = data.clients || data;
                    document.getElementById('syncStat1').textContent = clients.clients_created || 0;
                    document.getElementById('syncLabel1').textContent = 'Clients cr√©√©s';
                    document.getElementById('syncStat2').textContent = clients.clients_updated || 0;
                    document.getElementById('syncLabel2').textContent = 'Mis √† jour';
                    document.getElementById('syncStat3').textContent = clients.livraisons_created || 0;
                    document.getElementById('syncLabel3').textContent = 'Livraisons';
                    document.getElementById('syncStat4').textContent = clients.clients_deactivated || 0;
                    document.getElementById('syncLabel4').textContent = 'D√©sactiv√©s';
                }
                
                const details = data.total_details || data.details || (data.clients && data.clients.details) || [];
                document.getElementById('syncDetailsList').innerHTML = details.length
                    ? details.map(d => `<div class="detail-item">${d}</div>`).join('')
                    : '<div class="detail-item">Aucune modification</div>';
                
                syncResults.style.display = 'block';
                
            } catch (err) {
                syncError.textContent = 'Erreur: ' + err.message;
                syncError.classList.add('show');
            } finally {
                syncLoading.classList.remove('show');
                btn.disabled = false;
            }
        }
        
        syncAllBtn.addEventListener('click', () => doSync('/api/sync', syncAllBtn));
        // TODO: Remettre '/api/sync/pennylane' quand la sandbox n'est plus n√©cessaire
        syncPennylaneBtn.addEventListener('click', () => doSync('/api/test/fake-pennylane', syncPennylaneBtn));
        syncClientsBtn.addEventListener('click', () => doSync('/api/sync/clients', syncClientsBtn));

        // Cleanup
        const cleanupBtn = document.getElementById('cleanupBtn');
        const cleanupResult = document.getElementById('cleanupResult');
        cleanupBtn.addEventListener('click', async () => {
            if (!confirm('Supprimer toutes les donn√©es TEST et FAKE ?')) return;
            cleanupBtn.disabled = true;
            cleanupResult.style.display = 'none';
            try {
                const response = await fetch('/api/test/cleanup', { method: 'POST' });
                const data = await response.json();
                cleanupResult.innerHTML = `<span style="color: #27ae60;">‚úÖ ${data.suivi_deleted || 0} cartes Suivi + ${data.clients_deleted || 0} clients supprim√©s</span>`;
                cleanupResult.style.display = 'block';
            } catch (err) {
                cleanupResult.innerHTML = `<span style="color: #e74c3c;">‚ùå Erreur: ${err.message}</span>`;
                cleanupResult.style.display = 'block';
            } finally {
                cleanupBtn.disabled = false;
            }
        });

        // Tourn√©es
        const prepareTourneesBtn = document.getElementById('prepareTourneesBtn');
        const tourneesLoading = document.getElementById('tourneesLoading');
        const tourneesResults = document.getElementById('tourneesResults');
        const tourneesList = document.getElementById('tourneesList');
        const tourneesError = document.getElementById('tourneesError');
        
        prepareTourneesBtn.addEventListener('click', async () => {
            prepareTourneesBtn.disabled = true;
            tourneesLoading.classList.add('show');
            tourneesResults.style.display = 'none';
            tourneesList.innerHTML = '';
            tourneesError.classList.remove('show');
            
            try {
                const response = await fetch('/api/tournees');
                const data = await response.json();
                
                if (data.error) {
                    tourneesError.textContent = 'Erreur: ' + data.error;
                    tourneesError.classList.add('show');
                    return;
                }
                
                document.getElementById('totalClients').textContent = data.total_clients || 0;
                document.getElementById('totalBouquets').textContent = data.total_bouquets || 0;
                tourneesResults.style.display = 'block';
                
                // Afficher les groupes
                const suggestions = data.suggestions || [];
                if (suggestions.length === 0) {
                    tourneesList.innerHTML = '<div class="card"><p>Aucune livraison √† planifier pour le moment.</p></div>';
                } else {
                    tourneesList.innerHTML = suggestions.map(s => `
                        <div class="tournee-group">
                            <div class="tournee-header">
                                <span class="tournee-title">${s.group.replace('_', ' - ')}</span>
                                <span class="tournee-date">üìÖ ${s.date}</span>
                            </div>
                            <div class="tournee-stats">${s.nb_clients} clients ¬∑ ${s.nb_bouquets} bouquets</div>
                            <div class="tournee-clients">
                                ${s.clients.map(c => `
                                    <div class="client-item">
                                        <span class="client-name">${c.nom}</span>
                                        <span class="client-info">${c.nb_bouquets} bouquet(s)</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (err) {
                tourneesError.textContent = 'Erreur: ' + err.message;
                tourneesError.classList.add('show');
            } finally {
                tourneesLoading.classList.remove('show');
                prepareTourneesBtn.disabled = false;
            }
        });
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>
